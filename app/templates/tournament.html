{% extends "base.html" %}
{% block content %}
<h2>{{ tr('tournament_title') }}</h2>
<div class="alert alert-info mt-3">
  {{ tr('tournament_current_stage') }}: <strong>{{ current_stage_label }}</strong>
</div>

{% if groups %}
  <h3 class="mt-4">{{ tr('tournament_group_stage_top64') }}</h3>
  <div class="row g-3">
    {% for group in groups %}
    <div class="col-lg-6">
      <div class="card bg-black neon-border-blue">
        <div class="card-body">
          <h4>{{ group.name }} · {{ tr('tournament_game') }} {{ group.current_game }} · {{ tr('tournament_schedule') }}: {{ group.schedule_text or tr('tournament_tbd') }}</h4>
          <div>{{ tr('tournament_lobby_pw') }}: <span class="text-info">{{ group.lobby_password }}</span> · {{ tr('tournament_schedule') }}: <span class="text-warning">{{ group.schedule_text or tr('tournament_tbd') }}</span></div>
          <div class="small text-secondary mt-2">{{ tr('tournament_roster') }}: {% for member in group.members|sort(attribute='seat') %}#{{ member.seat }} · {{ member.user.nickname }} ({{ tr('tournament_id') }} {{ member.user_id }}){% if not loop.last %}; {% endif %}{% endfor %}</div>
          <table class="table table-dark table-sm mt-3">
            <tr><th>#</th><th>{{ tr('participants_nick') }}</th><th>{{ tr('participants_highest') }}</th><th>{{ tr('tournament_pts') }}</th><th>{{ tr('tournament_wins_short') }}</th><th>{{ tr('tournament_top4') }}</th></tr>
            {% for member in standings[group.id] %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ member.user.nickname }}</td>
              <td>{{ member.user.highest_rank }}</td>
              <td>{{ member.total_points }}</td>
              <td>{{ member.first_places }}</td>
              <td>{{ member.top4_finishes }}</td>
            </tr>
            {% endfor %}
          </table>
          <div class="small text-warning">{{ tr('tournament_promote_rule') }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% else %}
<div class="alert alert-secondary">{{ tr('tournament_no_draw') }}</div>
{% endif %}

{% if playoff_stages %}
  <h3 class="mt-5">{{ tr('tournament_playoff') }}</h3>
  {% for stage in playoff_stages %}
  <div class="card bg-black neon-border-red mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h4>{{ stage.title }}</h4>
        <span class="badge {{ 'bg-success' if stage.is_started else 'bg-secondary' }}">{{ tr('tournament_started') if stage.is_started else tr('tournament_pending') }}</span>
      </div>
      <p class="small text-secondary mb-1">{{ tr('tournament_scoring_mode') }}: {{ stage.scoring_mode }}{% if stage.scoring_mode == 'final_22_top1' %} ({{ tr('tournament_final_22_hint') }}){% endif %}</p>
      <p class="small text-secondary">{{ tr('tournament_matches') }}: {{ stage.matches|length }} · {{ tr('tournament_players') }}: {{ stage.participants|length }}</p>
      <div class="row g-3">
        <div class="col-lg-6">
          <h6>{{ tr('tournament_standings') }}</h6>
          <table class="table table-dark table-sm">
            <tr><th>#</th><th>{{ tr('tournament_user_id') }}</th><th>{{ tr('tournament_pts') }}</th><th>{{ tr('tournament_wins_short') }}</th><th>{{ tr('tournament_top4') }}</th><th>{{ tr('tournament_status') }}</th></tr>
            {% for participant in playoff_standings[stage.id] %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ participant.user_id }}</td>
              <td>{{ participant.points }}</td>
              <td>{{ participant.wins }}</td>
              <td>{{ participant.top4_finishes }}</td>
              <td>{{ tr('tournament_status_out') if participant.is_eliminated else tr('tournament_status_in') }}</td>
            </tr>
            {% endfor %}
          </table>
        </div>
        <div class="col-lg-6">
          <h6>{{ tr('tournament_schedule_status') }}</h6>
          <ul class="list-group list-group-flush">
            {% for match in stage.matches %}
            <li class="list-group-item bg-transparent text-light d-flex justify-content-between">
              <span>{{ tr('tournament_group') }} {{ match.group_number }} · {{ tr('tournament_game') }} {{ match.game_number }} · {{ tr('tournament_pw') }} {{ match.lobby_password }} · {{ tr('tournament_schedule') }} {{ match.schedule_text or tr('tournament_tbd') }}</span>
              <span>{{ match.state }}{% if match.winner_user_id %} · {{ tr('tournament_winner') }} {{ match.winner_user_id }}{% endif %}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
{% endif %}
{% endblock %}
