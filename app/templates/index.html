{% extends "base.html" %}
{% block content %}
{% if request.query_params.get('msg') %}<div class="alert alert-info">{{ tr(request.query_params.get('msg')) }}</div>{% endif %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card bg-black neon-border-red">
      <div class="card-body">
        <h2>{{ tr('register') }}</h2>
        {% if tournament_started %}<div class="alert alert-warning">{{ tr('registration_closed') }}</div>{% elif not registration_open %}<div class="alert alert-warning">{{ tr('registration_closed') }}</div>{% endif %}
        <form id="registration-form" action="/register" method="post">
          <label class="form-label" for="registration-nickname">{{ tr('index_nickname') }}</label>
          <input id="registration-nickname" class="form-control mb-2" name="nickname" placeholder="{{ tr('index_nickname') }}" required {% if not registration_open or tournament_started %}disabled{% endif %}>

          <label class="form-label" for="steam-input">{{ tr('index_steam_id_or_url') }}</label>
          <div class="input-group mb-2">
            <input id="steam-input" class="form-control" name="steam_input" placeholder="{{ tr('index_steam_id_or_url') }}" required {% if not registration_open or tournament_started %}disabled{% endif %}>
            <button id="steam-preview-btn" class="btn btn-outline-info" type="button" {% if not registration_open or tournament_started %}disabled{% endif %}>{{ tr('index_check_steam') }}</button>
          </div>

          <label class="form-label" for="preview-steam-id">{{ tr('index_steam_id') }}</label>
          <input id="preview-steam-id" class="form-control mb-2" placeholder="{{ tr('index_steam_id') }}" readonly>

          <label class="form-label" for="preview-game-nickname">{{ tr('index_game_nickname') }}</label>
          <input id="preview-game-nickname" class="form-control mb-2" placeholder="{{ tr('index_game_nickname') }}" readonly>

          <label class="form-label" for="preview-current-rank">{{ tr('index_current_rank') }}</label>
          <input id="preview-current-rank" class="form-control mb-2" placeholder="{{ tr('index_current_rank') }}" readonly>

          <label class="form-label" for="preview-highest-rank">{{ tr('index_highest_rank') }}</label>
          <input id="preview-highest-rank" class="form-control mb-2" placeholder="{{ tr('index_highest_rank') }}" readonly>

          <div id="steam-preview-message" class="small mb-2"></div>

          <label class="form-label" for="registration-telegram">{{ tr('participants_telegram') }}</label>
          <input id="registration-telegram" class="form-control mb-2" name="telegram" placeholder="{{ tr('participants_telegram') }}" {% if not registration_open or tournament_started %}disabled{% endif %}>

          <label class="form-label" for="registration-discord">{{ tr('participants_discord') }}</label>
          <input id="registration-discord" class="form-control mb-2" name="discord" placeholder="{{ tr('participants_discord') }}" {% if not registration_open or tournament_started %}disabled{% endif %}>
          <button id="register-submit" class="btn btn-danger" disabled>{{ tr('submit') }}</button>
        </form>
      </div>
    </div>

    <div id="chat" class="card bg-black neon-border-blue mt-4">
      <div class="card-body">
        <h3 class="text-contrast-neon">{{ tr('index_chat') }}</h3>
        <form action="/chat/send" method="post" class="mb-3">
          {% if not chat_settings.is_enabled %}<div class="alert alert-warning">{{ tr('msg_chat_disabled_admin') }}</div>{% endif %}
          <input class="form-control mb-2" name="temp_nick" placeholder="{{ tr('index_temp_nick') }}" required>
          <textarea class="form-control mb-2" name="message" maxlength="{{ chat_settings.max_length }}" placeholder="{{ tr('index_message') }}" required {% if not chat_settings.is_enabled %}disabled{% endif %}></textarea>
          <button class="btn btn-primary" {% if not chat_settings.is_enabled %}disabled{% endif %}>{{ tr('index_connect_send') }}</button>
          <div class="small text-contrast-muted">{{ tr('index_cooldown') }}: {{ chat_settings.cooldown_seconds }} sec · {{ tr('index_max_length') }}: {{ chat_settings.max_length }}</div>
        </form>
        <div class="chat-box">
          {% for msg in chat_messages %}
            <div><strong>{{ msg.temp_nick }}</strong>: {{ msg.message }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card bg-black neon-border-blue">
      <div class="card-body">
        <h3>{{ tr('index_stages') }}</h3>
        {% for stage in stages %}
          <div class="mb-2">{{ stage.title_en if lang == 'en' else stage.title_ru }} — {{ stage.date_text }} — {% if stage.is_active %}{{ tr('index_active') }}{% else %}{{ tr('index_done') }}{% endif %}</div>
        {% else %}
          <div>{{ tr('index_tbd') }}</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  const form = document.getElementById("registration-form");
  if (!form) return;

  const registrationAllowed = {{ 'true' if registration_open and not tournament_started else 'false' }};
  const steamInput = document.getElementById("steam-input");
  const previewBtn = document.getElementById("steam-preview-btn");
  const submitBtn = document.getElementById("register-submit");
  const message = document.getElementById("steam-preview-message");
  const steamIdField = document.getElementById("preview-steam-id");
  const nicknameField = document.getElementById("preview-game-nickname");
  const currentRankField = document.getElementById("preview-current-rank");
  const highestRankField = document.getElementById("preview-highest-rank");

  const setPreview = (data) => {
    steamIdField.value = data?.steam_id || "";
    nicknameField.value = data?.game_nickname || "";
    currentRankField.value = data?.current_rank || "";
    highestRankField.value = data?.highest_rank || "";
  };

  const setMessage = (text, isError = false) => {
    message.textContent = text;
    message.classList.toggle("text-danger", isError);
    message.classList.toggle("text-success", !isError && !!text);
  };

  const resetPreview = () => {
    setPreview(null);
    setMessage("");
    submitBtn.disabled = true;
  };

  steamInput?.addEventListener("input", resetPreview);

  previewBtn?.addEventListener("click", async () => {
    if (!registrationAllowed) {
      resetPreview();
      return;
    }
    const rawValue = steamInput?.value?.trim();
    if (!rawValue) {
      resetPreview();
      setMessage("{{ tr('js_enter_steam') }}", true);
      return;
    }

    previewBtn.disabled = true;
    setMessage("{{ tr('js_checking_steam') }}");

    try {
      const payload = new URLSearchParams();
      payload.set("steam_input", rawValue);
      const response = await fetch("/register/preview", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: payload.toString(),
      });
      const data = await response.json();

      if (!response.ok || !data.ok) {
        resetPreview();
        setMessage(data.error || "{{ tr('js_steam_data_failed') }}", true);
        return;
      }

      setPreview(data);
      setMessage("{{ tr('js_steam_ok') }}");
      if (registrationAllowed) submitBtn.disabled = false;
    } catch (err) {
      resetPreview();
      setMessage("{{ tr('js_steam_network_error') }}", true);
    } finally {
      previewBtn.disabled = false;
    }
  });
})();
</script>
{% endblock %}
