{% extends "base.html" %}
{% block content %}
{% if request.query_params.get('msg') %}<div class="alert alert-info">{{ request.query_params.get('msg') }}</div>{% endif %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card bg-black neon-border-red">
      <div class="card-body">
        <h2>{{ tr('register') }}</h2>
        {% if not registration_open %}<div class="alert alert-warning">{{ tr('registration_closed') }}</div>{% endif %}
        <form id="registration-form" action="/register" method="post">
          <input class="form-control mb-2" name="nickname" placeholder="Ник" required {% if not registration_open %}disabled{% endif %}>
          <div class="input-group mb-2">
            <input id="steam-input" class="form-control" name="steam_input" placeholder="Steam ID / URL" required {% if not registration_open %}disabled{% endif %}>
            <button id="steam-preview-btn" class="btn btn-outline-info" type="button" {% if not registration_open %}disabled{% endif %}>Проверить Steam</button>
          </div>
          <input id="preview-steam-id" class="form-control mb-2" placeholder="Steam ID" readonly>
          <input id="preview-game-nickname" class="form-control mb-2" placeholder="Game nickname" readonly>
          <input id="preview-current-rank" class="form-control mb-2" placeholder="Current rank" readonly>
          <input id="preview-highest-rank" class="form-control mb-2" placeholder="Highest rank" readonly>
          <div id="steam-preview-message" class="small mb-2"></div>
          <input class="form-control mb-2" name="telegram" placeholder="Telegram" {% if not registration_open %}disabled{% endif %}>
          <input class="form-control mb-2" name="discord" placeholder="Discord" {% if not registration_open %}disabled{% endif %}>
          <button id="register-submit" class="btn btn-danger" disabled>{{ tr('submit') }}</button>
        </form>
      </div>
    </div>

    <div id="chat" class="card bg-black neon-border-blue mt-4">
      <div class="card-body">
        <h3>Chat</h3>
        <form action="/chat/send" method="post" class="mb-3">
          <input class="form-control mb-2" name="temp_nick" placeholder="Temporary nickname" required>
          <textarea class="form-control mb-2" name="message" maxlength="1000" placeholder="Message" required></textarea>
          <button class="btn btn-primary">Connect & Send</button>
        </form>
        <div class="chat-box">
          {% for msg in chat_messages %}
            <div><strong>{{ msg.temp_nick }}</strong>: {{ msg.message }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card bg-black neon-border-blue">
      <div class="card-body">
        <h3>Stages</h3>
        {% for stage in stages %}
          <div class="mb-2">{{ stage.title_en if lang == 'en' else stage.title_ru }} — {{ stage.date_text }} — {% if stage.is_active %}active{% else %}done{% endif %}</div>
        {% else %}
          <div>TBD</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  const form = document.getElementById("registration-form");
  if (!form) return;

  const steamInput = document.getElementById("steam-input");
  const previewBtn = document.getElementById("steam-preview-btn");
  const submitBtn = document.getElementById("register-submit");
  const message = document.getElementById("steam-preview-message");
  const steamIdField = document.getElementById("preview-steam-id");
  const nicknameField = document.getElementById("preview-game-nickname");
  const currentRankField = document.getElementById("preview-current-rank");
  const highestRankField = document.getElementById("preview-highest-rank");

  const setPreview = (data) => {
    steamIdField.value = data?.steam_id || "";
    nicknameField.value = data?.game_nickname || "";
    currentRankField.value = data?.current_rank || "";
    highestRankField.value = data?.highest_rank || "";
  };

  const setMessage = (text, isError = false) => {
    message.textContent = text;
    message.classList.toggle("text-danger", isError);
    message.classList.toggle("text-success", !isError && !!text);
  };

  const resetPreview = () => {
    setPreview(null);
    setMessage("");
    submitBtn.disabled = true;
  };

  steamInput?.addEventListener("input", resetPreview);

  previewBtn?.addEventListener("click", async () => {
    const rawValue = steamInput?.value?.trim();
    if (!rawValue) {
      resetPreview();
      setMessage("Введите Steam ID или ссылку.", true);
      return;
    }

    previewBtn.disabled = true;
    setMessage("Проверяем Steam...");

    try {
      const payload = new URLSearchParams();
      payload.set("steam_input", rawValue);
      const response = await fetch("/register/preview", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: payload.toString(),
      });
      const data = await response.json();

      if (!response.ok || !data.ok) {
        resetPreview();
        setMessage(data.error || "Не удалось получить данные Steam.", true);
        return;
      }

      setPreview(data);
      setMessage("Steam проверен, можно отправлять форму.");
      submitBtn.disabled = false;
    } catch (err) {
      resetPreview();
      setMessage("Ошибка сети при проверке Steam.", true);
    } finally {
      previewBtn.disabled = false;
    }
  });
})();
</script>
{% endblock %}
